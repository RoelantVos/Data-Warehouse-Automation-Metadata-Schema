dataObjectMapping:
  name: m_200_MIDAS_POLICY_PREMIUM_ADD_ON_CUSTOMER_FN_LNK_SALE_PREMIUM_COMPONENT_CUSTOMER
  source:
    dataStore:
      connectionKey: HSTG
    dataObject:
      objectType: query
      language: T-SQL
      code: |
        select SALE_PREMIUM_COMPONENT_SK,
            CUSTOMER_SK,
            OMD_INSERT_DATETIME,
            OMD_INSERT_MODULE_INSTANCE_ID,
            SALE_PREMIUM_COMPONENT_CUSTOMER_SK
        from    (
                select hubSKs.SALE_PREMIUM_COMPONENT_SK,
                    hubSKs.CUSTOMER_SK,
                    POLICY_PREMIUM_ADD_ON_CUSTOMER.OMD_INSERT_DATETIME,
                    POLICY_PREMIUM_ADD_ON_CUSTOMER.OMD_INSERT_MODULE_INSTANCE_ID,
                    hashbytes('MD5',
                                isnull(hubSKs.SALE_PREMIUM_COMPONENT_SK, 'NA') + '|'
                                + isnull(hubSKs.CUSTOMER_SK, 'NA') + '|'
                                ) as SALE_PREMIUM_COMPONENT_CUSTOMER_SK,
                    row_number() over (partition by hubSKs.SALE_PREMIUM_COMPONENT_SK,
                                                    hubSKs.CUSTOMER_SK
                                        order by POLICY_PREMIUM_ADD_ON_CUSTOMER.OMD_INSERT_DATETIME asc
                                        ) as rn
                from dbo.HSTG_MIDAS_POLICY_PREMIUM_ADD_ON_CUSTOMER_FN(@start_datetime, @end_datetime) POLICY_PREMIUM_ADD_ON_CUSTOMER
                    cross apply (
                            select convert(bigint, POLICY_PREMIUM_ADD_ON_CUSTOMER.POLICY_PREMIUM_COMPONENT_ID) as POLICY_PREMIUM_COMPONENT_ID,
                                convert(bigint, POLICY_PREMIUM_ADD_ON_CUSTOMER.CUSTOMER_ID) as CUSTOMER_ID
                            ) as intendedDataType
                    cross apply ( /* REM SK calcs to be pulled from TEAM metadata */
                            select convert(nvarchar(100), intendedDataType.POLICY_PREMIUM_COMPONENT_ID) + N'_' + POLICY_PREMIUM_ADD_ON_CUSTOMER.OMD_RECORD_SOURCE as SALE_PREMIUM_COMPONENT_SK,
                                convert(nvarchar(100), intendedDataType.CUSTOMER_ID) + N'_' + POLICY_PREMIUM_ADD_ON_CUSTOMER.OMD_RECORD_SOURCE as CUSTOMER_SK
                            ) as hubSKs
                ) src
        where src.rn = 1
            and not exists (
                select null
                from EDW_200_Integration_Layer.dbo.LNK_SALE_PREMIUM_COMPONENT_CUSTOMER
                where LNK_SALE_PREMIUM_COMPONENT_CUSTOMER.SALE_PREMIUM_COMPONENT_CUSTOMER_SK = src.SALE_PREMIUM_COMPONENT_CUSTOMER_SK
                );
  targetDataItem:
    dataStore:
      connectionKey: INT
    dataObject:
      objectSchema: dbo
      objectName: LNK_SALE_PREMIUM_COMPONENT_CUSTOMER
  dataObjectMappings:
    - sourceDataItem:
        columnName: SALE_PREMIUM_COMPONENT_SK
      targetDataItem:
        columnName: SALE_PREMIUM_COMPONENT_SK
    - sourceDataItem:
        columnName: CUSTOMER_SK
      targetDataItem:
        columnName: CUSTOMER_SK
    - sourceDataItem:
        columnName: OMD_INSERT_DATETIME
      targetDataItem:
        columnName: OMD_FIRST_SEEN_DATETIME
    - sourceDataItem:
        columnName: OMD_INSERT_MODULE_INSTANCE_ID
      targetDataItem:
        columnName: OMD_INSERT_MODULE_INSTANCE_ID
    - sourceDataItem:
        columnName: SALE_PREMIUM_COMPONENT_CUSTOMER_SK
      targetDataItem:
        columnName: SALE_PREMIUM_COMPONENT_CUSTOMER_SK
